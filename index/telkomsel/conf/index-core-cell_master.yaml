# ds_transform_cell_master using Cell Master Information
# author: ashutosh

# application name
name: ds_transform_cell_master

# input arguments
arguments:
    - !argument
        name: input_path
        description:
        required: true

    - !argument
        name: collection
        description: collection name
        required: true
    - !argument
        name: zk
        description: zookeeper
        required: true
        
# data source
source:
    !!com.dataspark.sources.TextFileSource
        uri: !arg input_path

# main processing jobs
job:
    !!com.dataspark.jobs.composite.RDDPipelineJob
        pipeline:
            # decode source data line by line
            - !!com.dataspark.jobs.transformations.ValueDecodingJob
                decoder: !!com.dataspark.codecs.DelimitedRecordStringDecoder
                    delimiter: '\|'
                    inner: !!com.dataspark.codecs.MapDecoder
                        fields:
                            - !!com.dataspark.codecs.Field
                                name: cgi_s
                                index: 0
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: lat
                                index: 1
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true
                            - !!com.dataspark.codecs.Field
                                name: lon
                                index: 2
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true
                            - !!com.dataspark.codecs.Field
                                name: networks_s
                                index: 3
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: site_id_s
                                index: 4
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: site_name_s
                                index: 5
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: roi4_id_s
                                index: 6
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: roi3_id_s
                                index: 7
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: roi2_id_s
                                index: 8
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true
                            - !!com.dataspark.codecs.Field
                                name: roi1_id_s
                                index: 9
                                decoder: !!com.dataspark.codecs.StringDecoder
                                    nullable: true
                                    trim: true                                    
                            - !!com.dataspark.codecs.Field
                                name: vol_2g
                                index: 11
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true
                            - !!com.dataspark.codecs.Field
                                name: vol_3g
                                index: 12
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true
                            - !!com.dataspark.codecs.Field
                                name: vol_4g
                                index: 13
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true
                            - !!com.dataspark.codecs.Field
                                name: rev
                                index: 14
                                decoder: !!com.dataspark.codecs.DoubleDecoder
                                    nullable: true                                                                                                            
                                    
            # enrich/transform data
            - !!com.dataspark.jobs.transformations.ProcessingJob
                enrichers:
                    - !!com.dataspark.jobs.transformations.FormattedStringEnricher
                        inputFields: [lat, lon]
                        outputField: lat_lon_s
                        targetFormat: '%.5f_%.5f'

                    - !!com.dataspark.jobs.transformations.FormattedStringEnricher
                        inputFields: [cgi_s, roi1_id_s]
                        outputField: cgi_roi1_s
                        targetFormat: '%s_%s'
                        
                    - !!com.dataspark.jobs.transformations.JavaExpression
                        outputField: vol_2g_td
                        inputFields: [vol_2g]
                        exp: 'vol_2g == null ? new Double(0) : vol_2g'                    

                    - !!com.dataspark.jobs.transformations.JavaExpression
                        outputField: vol_3g_td
                        inputFields: [vol_3g]
                        exp: 'vol_3g == null ? new Double(0) : vol_3g'    

                    - !!com.dataspark.jobs.transformations.JavaExpression
                        outputField: vol_4g_td
                        inputFields: [vol_4g]
                        exp: 'vol_4g == null ? new Double(0) : vol_4g'   

                    - !!com.dataspark.jobs.transformations.JavaExpression
                        outputField: rev_td
                        inputFields: [rev]
                        exp: 'rev == null ? new Double(0) : rev'

            - !!com.dataspark.jobs.transformations.MapTransformJob
                whitelist: true
                filterFields: [cgi_roi1_s,cgi_s,lat_lon_s,networks_s,site_id_s,site_name_s,roi4_id_s,roi3_id_s,roi2_id_s,roi1_id_s,vol_2g_td,vol_3g_td,vol_4g_td,rev_td]
                        
            - !!com.dataspark.jobs.outputs.SolrOutputJob
                keyField: "cgi_roi1_s"
                solrCollection: !arg collection
                zkHostString: !arg zk
                replaceMultiValues: true
                partitions: 100
                upsert: true                        
